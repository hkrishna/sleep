<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brooklyn Towers Sleep Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .emoji-main {
            font-size: 8rem;
            line-height: 1;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .emoji-main:hover {
            transform: scale(1.1);
        }
        .emoji-main:active {
            transform: scale(0.95);
        }
        @media (max-width: 640px) {
            .emoji-main {
                font-size: 6rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    <div id="app" class="flex items-center justify-center min-h-screen p-4">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-amber-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-300 text-lg">Checking winds...</p>
        </div>
    </div>

    <script>
        // REPLACE THIS WITH YOUR API KEY FROM openweathermap.org
        const API_KEY = '5288d5a78ce0e73bdd53f0b8fe3a28c3';
        const LAT = 40.6942;
        const LON = -73.9866;
        const USE_DEMO_MODE = API_KEY === 'YOUR_API_KEY_HERE';
        const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes in milliseconds

        let currentData = null;
        let showingDetails = false;

        async function fetchWeatherData() {
            try {
                // Check cache first
                const cachedData = getCachedWeather();
                if (cachedData) {
                    console.log('Using cached weather data');
                    currentData = cachedData.analysis;
                    renderSimple(cachedData.analysis, cachedData.isDemo);
                    return;
                }

                if (USE_DEMO_MODE) {
                    const demoData = generateDemoData();
                    const analysis = analyzeNighttimeWinds(demoData);
                    currentData = analysis;
                    cacheWeatherData(analysis, true);
                    renderSimple(analysis, true);
                    return;
                }

                console.log('Fetching fresh weather data from API...');
                // Direct fetch - works perfectly on Netlify
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?lat=${LAT}&lon=${LON}&appid=${API_KEY}&units=imperial`
                );
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid API key. Wait 10-15 min for activation or check openweathermap.org');
                    }
                    throw new Error(`Weather API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.list || data.list.length === 0) {
                    throw new Error('No forecast data available');
                }
                
                const analysis = analyzeNighttimeWinds(data.list);
                currentData = analysis;
                cacheWeatherData(analysis, false);
                renderSimple(analysis, false);
            } catch (error) {
                console.error('Weather fetch error:', error);
                renderError(error.message);
            }
        }

        function getCachedWeather() {
            try {
                const cached = localStorage.getItem('weatherCache');
                if (!cached) return null;

                const data = JSON.parse(cached);
                const now = Date.now();
                
                // Check if cache is still valid (within 30 minutes)
                if (now - data.timestamp < CACHE_DURATION) {
                    return data;
                }
                
                // Cache expired, remove it
                localStorage.removeItem('weatherCache');
                return null;
            } catch (e) {
                console.error('Error reading cache:', e);
                return null;
            }
        }

        function cacheWeatherData(analysis, isDemo) {
            try {
                const cacheData = {
                    analysis: analysis,
                    isDemo: isDemo,
                    timestamp: Date.now()
                };
                localStorage.setItem('weatherCache', JSON.stringify(cacheData));
                console.log('Weather data cached');
            } catch (e) {
                console.error('Error caching data:', e);
            }
        }

        function forceRefresh() {
            localStorage.removeItem('weatherCache');
            location.reload();
        }

        function generateDemoData() {
            const now = new Date();
            const data = [];
            
            for (let i = 0; i < 40; i++) {
                const time = new Date(now.getTime() + (i * 3 * 60 * 60 * 1000));
                const hour = time.getHours();
                
                let baseWind = 8 + Math.random() * 8;
                if (hour >= 21 || hour < 7) {
                    baseWind += Math.random() * 12;
                }
                
                data.push({
                    dt: time.getTime() / 1000,
                    wind: {
                        speed: Math.round(baseWind),
                        gust: Math.round(baseWind + Math.random() * 5)
                    }
                });
            }
            
            return data;
        }

        function analyzeNighttimeWinds(forecastList) {
            const now = new Date();
            const tonight9PM = new Date(now);
            tonight9PM.setHours(21, 0, 0, 0);
            
            if (now.getHours() < 7) {
                // Already in nighttime
            } else if (tonight9PM < now) {
                tonight9PM.setTime(now.getTime());
            }
            
            const tomorrow7AM = new Date(tonight9PM);
            tomorrow7AM.setHours(tomorrow7AM.getHours() + 10);
            
            const nighttimePeriods = forecastList.filter(item => {
                const itemTime = new Date(item.dt * 1000);
                const hour = itemTime.getHours();
                return itemTime >= tonight9PM && itemTime <= tomorrow7AM &&
                       (hour >= 21 || hour < 7);
            });
            
            const windSpeeds = nighttimePeriods.map(item => {
                const windSpeed = Math.round(item.wind.speed);
                const windGust = item.wind.gust ? Math.round(item.wind.gust) : windSpeed;
                return Math.max(windSpeed, windGust);
            });
            
            const maxWind = windSpeeds.length > 0 ? Math.max(...windSpeeds) : 0;
            const avgWind = windSpeeds.length > 0 
                ? Math.round(windSpeeds.reduce((a, b) => a + b, 0) / windSpeeds.length) 
                : 0;
            
            return {
                maxWind,
                avgWind,
                shouldSleepInStudy: maxWind >= 20,
                nighttimePeriods: nighttimePeriods.slice(0, 6)
            };
        }

        function toggleDetails() {
            showingDetails = !showingDetails;
            if (showingDetails) {
                renderDetails(currentData);
            } else {
                renderSimple(currentData, USE_DEMO_MODE);
            }
        }

        function renderSimple(data, isDemo) {
            const emoji = data.shouldSleepInStudy ? 'ü´®' : 'üò¥';
            const room = data.shouldSleepInStudy ? 'Study' : 'Bedroom';
            
            // Check cache age for display
            const cached = localStorage.getItem('weatherCache');
            const cacheAge = cached ? Date.now() - JSON.parse(cached).timestamp : 0;
            const minutesOld = Math.floor(cacheAge / 60000);
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-lg w-full text-center">
                    ${isDemo ? `
                        <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl px-4 py-2 mb-8 inline-block">
                            <p class="text-amber-300 text-xs font-medium">DEMO MODE</p>
                        </div>
                    ` : minutesOld > 0 ? `
                        <div class="bg-slate-700/30 border border-slate-600/30 rounded-xl px-4 py-2 mb-8 inline-block">
                            <p class="text-slate-400 text-xs">Updated ${minutesOld} min ago</p>
                        </div>
                    ` : ''}
                    
                    <div onclick="toggleDetails()" class="emoji-main select-none">
                        ${emoji}
                    </div>
                    
                    <h1 class="text-3xl md:text-4xl font-light text-slate-100 mt-6 mb-2">
                        ${room}
                    </h1>
                    
                    <p class="text-slate-400 text-sm mb-8">
                        ${data.maxWind} mph max tonight
                    </p>
                    
                    <button onclick="toggleDetails()" class="text-slate-500 hover:text-slate-300 text-xs transition-colors">
                        tap for details
                    </button>
                </div>
            `;
        }

        function renderDetails(data) {
            const emoji = data.shouldSleepInStudy ? 'ü´®' : 'üò¥';
            const room = data.shouldSleepInStudy ? 'Study' : 'Bedroom';
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-lg w-full">
                    <div class="text-center mb-8">
                        <div onclick="toggleDetails()" class="emoji-main select-none inline-block" style="font-size: 4rem;">
                            ${emoji}
                        </div>
                        <h1 class="text-2xl font-light text-slate-100 mt-4">${room}</h1>
                    </div>

                    <!-- Wind Stats -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-4">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="text-center">
                                <p class="text-slate-400 text-sm mb-1">Max Wind</p>
                                <p class="text-3xl font-light ${data.maxWind >= 20 ? 'text-orange-400' : 'text-emerald-400'}">
                                    ${data.maxWind}<span class="text-lg ml-1">mph</span>
                                </p>
                            </div>
                            <div class="text-center">
                                <p class="text-slate-400 text-sm mb-1">Avg Wind</p>
                                <p class="text-3xl font-light text-slate-300">
                                    ${data.avgWind}<span class="text-lg ml-1">mph</span>
                                </p>
                            </div>
                        </div>

                        <!-- Hourly Breakdown -->
                        <div class="border-t border-slate-700 pt-4">
                            <p class="text-slate-400 text-sm mb-3">Tonight (9PM-7AM)</p>
                            <div class="space-y-2">
                                ${data.nighttimePeriods.map(period => {
                                    const time = new Date(period.dt * 1000).toLocaleTimeString('en-US', {
                                        hour: 'numeric',
                                        hour12: true,
                                        timeZone: 'America/New_York'
                                    });
                                    const windSpeed = Math.round(period.wind.speed);
                                    const windGust = period.wind.gust ? Math.round(period.wind.gust) : windSpeed;
                                    const maxWindSpeed = Math.max(windSpeed, windGust);
                                    
                                    return `
                                        <div class="flex items-center justify-between text-sm">
                                            <span class="text-slate-400 w-16">${time}</span>
                                            <div class="flex items-center gap-2 flex-1 ml-4">
                                                <div class="flex-1 bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                                    <div class="h-full ${maxWindSpeed >= 20 ? 'bg-orange-400' : 'bg-emerald-400'}" 
                                                         style="width: ${Math.min((maxWindSpeed / 30) * 100, 100)}%"></div>
                                                </div>
                                                <span class="text-slate-300 w-12 text-right font-medium ${maxWindSpeed >= 20 ? 'text-orange-400' : ''}">
                                                    ${maxWindSpeed}
                                                </span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="text-center space-y-2">
                        <button onclick="location.reload()" class="text-slate-400 hover:text-amber-400 text-sm transition-colors">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <br>
                        <button onclick="toggleDetails()" class="text-slate-500 hover:text-slate-300 text-xs transition-colors">
                            back to simple view
                        </button>
                    </div>
                </div>
            `;
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="bg-slate-800 border border-red-500/30 rounded-2xl p-8 max-w-md text-center">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-xl font-semibold text-red-400 mb-2">Error</h2>
                    <p class="text-slate-400 text-sm mb-4">${message}</p>
                    <button onclick="location.reload()" class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-medium py-2 px-6 rounded-lg transition-colors text-sm">
                        Try Again
                    </button>
                </div>
            `;
        }

        fetchWeatherData();
    </script>
</body>
</html>