<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brooklyn Towers Sleep Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .emoji-main {
            font-size: 8rem;
            line-height: 1;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .emoji-main:hover {
            transform: scale(1.1);
        }
        .emoji-main:active {
            transform: scale(0.95);
        }
        .emoji-small {
            font-size: 2.5rem;
            line-height: 1;
        }
        @media (max-width: 640px) {
            .emoji-main {
                font-size: 6rem;
            }
            .emoji-small {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    <div id="app" class="flex items-center justify-center min-h-screen p-4">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-amber-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-300 text-lg">Checking winds...</p>
        </div>
    </div>

    <script>
        const API_KEY = '5288d5a78ce0e73bdd53f0b8fe3a28c3';
        const LAT = 40.6942;
        const LON = -73.9866;
        const USE_DEMO_MODE = API_KEY === 'YOUR_API_KEY_HERE';
        const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

        let forecastData = null;
        let showingDetails = false;

        async function fetchWeatherData() {
            try {
                const cachedData = getCachedWeather();
                if (cachedData) {
                    console.log('Using cached weather data');
                    forecastData = cachedData.forecast;
                    renderSimple(cachedData.forecast, cachedData.isDemo);
                    return;
                }

                if (USE_DEMO_MODE) {
                    const demoData = generateDemoData();
                    const forecast = analyzeForecast(demoData);
                    forecastData = forecast;
                    cacheWeatherData(forecast, true);
                    renderSimple(forecast, true);
                    return;
                }

                console.log('Fetching fresh weather data from API...');
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?lat=${LAT}&lon=${LON}&appid=${API_KEY}&units=imperial`
                );
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid API key');
                    }
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.list || data.list.length === 0) {
                    throw new Error('No forecast data available');
                }
                
                const forecast = analyzeForecast(data.list);
                forecastData = forecast;
                cacheWeatherData(forecast, false);
                renderSimple(forecast, false);
            } catch (error) {
                console.error('Weather fetch error:', error);
                renderError(error.message);
            }
        }

        function generateDemoData() {
            const now = new Date();
            const data = [];
            
            for (let i = 0; i < 120; i++) { // 5 days of 3-hour intervals
                const time = new Date(now.getTime() + (i * 3 * 60 * 60 * 1000));
                const hour = time.getHours();
                
                let baseWind = 8 + Math.random() * 8;
                if (hour >= 21 || hour < 7) {
                    baseWind += Math.random() * 12;
                }
                
                data.push({
                    dt: time.getTime() / 1000,
                    wind: {
                        speed: Math.round(baseWind),
                        gust: Math.round(baseWind + Math.random() * 5)
                    }
                });
            }
            
            return data;
        }

        function analyzeForecast(forecastList) {
            const dailyForecasts = [];
            const now = new Date();
            
            // Group by date and analyze nighttime winds (9PM-7AM)
            for (let dayOffset = 0; dayOffset < 5; dayOffset++) {
                const targetDate = new Date(now);
                targetDate.setDate(targetDate.getDate() + dayOffset);
                targetDate.setHours(21, 0, 0, 0); // 9PM
                
                const nextMorning = new Date(targetDate);
                nextMorning.setHours(31, 0, 0, 0); // 7AM next day
                
                const nightPeriods = forecastList.filter(item => {
                    const itemTime = new Date(item.dt * 1000);
                    const hour = itemTime.getHours();
                    return itemTime >= targetDate && itemTime <= nextMorning &&
                           (hour >= 21 || hour < 7);
                });
                
                if (nightPeriods.length === 0) continue;
                
                const windSpeeds = nightPeriods.map(item => {
                    const windSpeed = Math.round(item.wind.speed);
                    const windGust = item.wind.gust ? Math.round(item.wind.gust) : windSpeed;
                    return Math.max(windSpeed, windGust);
                });
                
                const maxWind = Math.max(...windSpeeds);
                const avgWind = Math.round(windSpeeds.reduce((a, b) => a + b, 0) / windSpeeds.length);
                
                dailyForecasts.push({
                    date: targetDate,
                    maxWind: maxWind,
                    avgWind: avgWind,
                    shouldSleepInStudy: maxWind >= 20,
                    nightPeriods: nightPeriods.slice(0, 4)
                });
            }
            
            return dailyForecasts;
        }

        function getCachedWeather() {
            try {
                const cached = localStorage.getItem('weatherCache');
                if (!cached) return null;

                const data = JSON.parse(cached);
                const now = Date.now();
                
                if (now - data.timestamp < CACHE_DURATION) {
                    return data;
                }
                
                localStorage.removeItem('weatherCache');
                return null;
            } catch (e) {
                console.error('Error reading cache:', e);
                return null;
            }
        }

        function cacheWeatherData(forecast, isDemo) {
            try {
                const cacheData = {
                    forecast: forecast,
                    isDemo: isDemo,
                    timestamp: Date.now()
                };
                localStorage.setItem('weatherCache', JSON.stringify(cacheData));
                console.log('Weather data cached');
            } catch (e) {
                console.error('Error caching data:', e);
            }
        }

        function forceRefresh() {
            localStorage.removeItem('weatherCache');
            location.reload();
        }

        function toggleDetails() {
            showingDetails = !showingDetails;
            if (showingDetails) {
                renderDetails(forecastData);
            } else {
                renderSimple(forecastData, USE_DEMO_MODE);
            }
        }

        function renderSimple(forecast, isDemo) {
            if (!forecast || forecast.length === 0) {
                renderError('No forecast data available');
                return;
            }

            const today = forecast[0];
            const emoji = today.shouldSleepInStudy ? 'ü´®' : 'üò¥';
            
            const cached = localStorage.getItem('weatherCache');
            const cacheAge = cached ? Date.now() - JSON.parse(cached).timestamp : 0;
            const minutesOld = Math.floor(cacheAge / 60000);
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-lg w-full text-center">
                    ${isDemo ? `
                        <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl px-4 py-2 mb-8 inline-block">
                            <p class="text-amber-300 text-xs font-medium">DEMO MODE</p>
                        </div>
                    ` : minutesOld > 0 ? `
                        <div class="bg-slate-700/30 border border-slate-600/30 rounded-xl px-4 py-2 mb-8 inline-block">
                            <p class="text-slate-400 text-xs">Updated ${minutesOld} min ago</p>
                        </div>
                    ` : ''}
                    
                    <div onclick="toggleDetails()" class="emoji-main select-none">
                        ${emoji}
                    </div>
                    
                    <p class="text-slate-400 text-sm mt-6 mb-8">
                        ${today.maxWind} mph max tonight
                    </p>
                    
                    <button onclick="toggleDetails()" class="text-slate-500 hover:text-slate-300 text-xs transition-colors">
                        tap for details
                    </button>
                </div>
            `;
        }

        function renderDetails(forecast) {
            const today = forecast[0];
            const emoji = today.shouldSleepInStudy ? 'ü´®' : 'üò¥';
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-2xl w-full">
                    <div class="text-center mb-8">
                        <div onclick="toggleDetails()" class="emoji-main select-none inline-block" style="font-size: 4rem;">
                            ${emoji}
                        </div>
                        <p class="text-slate-400 text-sm mt-2">Tonight</p>
                    </div>

                    <!-- Tonight's detailed forecast -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-6">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="text-center">
                                <p class="text-slate-400 text-sm mb-1">Max Wind</p>
                                <p class="text-3xl font-light ${today.maxWind >= 20 ? 'text-orange-400' : 'text-emerald-400'}">
                                    ${today.maxWind}<span class="text-lg ml-1">mph</span>
                                </p>
                            </div>
                            <div class="text-center">
                                <p class="text-slate-400 text-sm mb-1">Avg Wind</p>
                                <p class="text-3xl font-light text-slate-300">
                                    ${today.avgWind}<span class="text-lg ml-1">mph</span>
                                </p>
                            </div>
                        </div>

                        <div class="border-t border-slate-700 pt-4">
                            <p class="text-slate-400 text-sm mb-3">Hourly (9PM-7AM)</p>
                            <div class="space-y-2">
                                ${today.nightPeriods.map(period => {
                                    const time = new Date(period.dt * 1000).toLocaleTimeString('en-US', {
                                        hour: 'numeric',
                                        hour12: true,
                                        timeZone: 'America/New_York'
                                    });
                                    const windSpeed = Math.round(period.wind.speed);
                                    const windGust = period.wind.gust ? Math.round(period.wind.gust) : windSpeed;
                                    const maxWindSpeed = Math.max(windSpeed, windGust);
                                    
                                    return `
                                        <div class="flex items-center justify-between text-sm">
                                            <span class="text-slate-400 w-16">${time}</span>
                                            <div class="flex items-center gap-2 flex-1 ml-4">
                                                <div class="flex-1 bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                                    <div class="h-full ${maxWindSpeed >= 20 ? 'bg-orange-400' : 'bg-emerald-400'}" 
                                                         style="width: ${Math.min((maxWindSpeed / 30) * 100, 100)}%"></div>
                                                </div>
                                                <span class="text-slate-300 w-12 text-right font-medium ${maxWindSpeed >= 20 ? 'text-orange-400' : ''}">
                                                    ${maxWindSpeed}
                                                </span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- All days forecast -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-6">
                        <p class="text-slate-400 text-sm mb-4">5-Day Forecast</p>
                        <div class="space-y-3">
                            ${forecast.slice(0, 5).map((day, idx) => {
                                const dayEmoji = day.shouldSleepInStudy ? 'ü´®' : 'üò¥';
                                const date = new Date(day.date);
                                const dateStr = idx === 0 ? 'Tonight' : 
                                               idx === 1 ? 'Tomorrow' :
                                               date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                                
                                return `
                                    <div class="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                                        <div class="flex items-center gap-3 flex-1">
                                            <span class="text-3xl">${dayEmoji}</span>
                                            <span class="text-slate-300 text-sm">${dateStr}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="w-24 bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                                <div class="h-full ${day.maxWind >= 20 ? 'bg-orange-400' : 'bg-emerald-400'}" 
                                                     style="width: ${Math.min((day.maxWind / 30) * 100, 100)}%"></div>
                                            </div>
                                            <span class="text-sm font-medium w-12 text-right ${day.maxWind >= 20 ? 'text-orange-400' : 'text-slate-300'}">
                                                ${day.maxWind} mph
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="text-center space-y-2">
                        <button onclick="forceRefresh()" class="text-slate-400 hover:text-amber-400 text-sm transition-colors">
                            Force Refresh
                        </button>
                        <br>
                        <button onclick="toggleDetails()" class="text-slate-500 hover:text-slate-300 text-xs transition-colors">
                            back to simple view
                        </button>
                    </div>
                </div>
            `;
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="bg-slate-800 border border-red-500/30 rounded-2xl p-8 max-w-md text-center">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-xl font-semibold text-red-400 mb-2">Error</h2>
                    <p class="text-slate-400 text-sm mb-4">${message}</p>
                    <button onclick="location.reload()" class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-medium py-2 px-6 rounded-lg transition-colors text-sm">
                        Try Again
                    </button>
                </div>
            `;
        }

        fetchWeatherData();
    </script>
</body>
</html>